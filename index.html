<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Practice: Seijin no Hi (Part 3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; }
        .font-english { font-family: "Times New Roman", Times, "Noto Serif", serif; }
        .font-japanese { font-family: "UD Digital Kyokasho-tai-R", "UD Digi Kyokasho N-R", "BIZ UDPGothic", "Hiragino Maru Gothic ProN", sans-serif; }

        /* BLANK STYLING */
        .blank-container {
            display: inline-flex; align-items: center; justify-content: flex-start;
            min-width: 160px; height: 2.4em; background-color: #f1f5f9;
            border-radius: 6px; padding: 0 10px; margin: 4px 3px; vertical-align: middle;
            color: #64748b; font-weight: bold; font-size: 1em; cursor: pointer; border-bottom: none;
            transition: all 0.2s ease;
            user-select: none;
        }
        .blank-container:hover { background-color: #e2e8f0; }

        /* REVEALED STATE */
        .blank-container.revealed {
            justify-content: center; background-color: #ffffff !important;
            color: #ef4444; border: 2px solid #ef4444; min-width: auto; padding: 0 12px; margin: 2px 3px;
            cursor: default;
        }

        .paren { color: #94a3b8; font-size: 1.1em; }
        .hint-text { margin-left: 4px; white-space: nowrap; }
        .paren-right { margin-left: auto; }

        .row-container { transition: all 0.3s ease; border-left: 4px solid transparent; }
        .row-container.active-row { background-color: #eff6ff !important; border-left-color: #3b82f6; }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .pulse-recording { animation: pulse 1.5s infinite; }
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
        }
    </style>
</head>
<body class="text-slate-800 pb-80">

    <!-- Navbar -->
    <nav class="bg-slate-800 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-book-open text-2xl text-blue-400"></i>
                <h1 class="text-xl font-bold leading-tight font-english">U8: Seijin no Hi (Part 3)</h1>
            </div>
            <div class="text-sm font-medium bg-slate-700 px-4 py-1.5 rounded-full border border-slate-600">
                <span id="progress-text" class="text-blue-400 font-bold">0/0</span> Revealed
            </div>
        </div>
    </nav>

    <!-- Controls -->
    <div class="sticky top-[72px] z-40 bg-f8fafc/95 backdrop-blur-sm transition-all border-b border-slate-200 shadow-sm py-3">
        <div class="max-w-7xl mx-auto px-4 flex flex-wrap gap-3 justify-center md:justify-end items-center">
            <button id="btn-play-all" onclick="playAllAudio()" class="flex items-center gap-2 px-4 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition font-medium text-sm shadow-sm font-english mr-auto md:mr-0">
                <i class="fas fa-circle-play text-lg"></i> <span>Play Model Audio</span>
            </button>
            <div class="h-6 w-px bg-slate-300 mx-1 hidden md:block"></div>
            <button id="btn-toggle-jp" class="flex items-center gap-2 px-4 py-2 rounded-full bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 transition font-medium text-sm shadow-sm font-japanese">
                <i class="fas fa-language text-lg text-slate-500"></i> <span>日本語: <b class="text-blue-600">ON</b></span>
            </button>
            <button onclick="resetApp()" class="flex items-center gap-2 px-4 py-2 rounded-full bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 transition font-medium text-sm shadow-sm font-japanese">
                <i class="fas fa-redo text-slate-500"></i> Reset
            </button>
        </div>
    </div>

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <div class="bg-white shadow-md rounded-xl overflow-hidden border border-slate-200">
            <div class="hidden md:flex bg-slate-100 border-b border-slate-300 text-sm font-bold text-slate-600">
                <div class="flex-[3] p-4 border-r border-slate-200 font-english">English Text</div>
                <div class="flex-[2] p-4 font-japanese">Japanese Meaning</div>
            </div>
            <div id="app" class="divide-y divide-slate-200"></div>
        </div>
    </main>

    <!-- Bottom Action Bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-50">
        <div class="max-w-4xl mx-auto flex flex-col gap-4">
            
            <!-- Voice Recorder Section -->
            <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-200">
                <div class="flex items-center gap-3">
                    <button id="btn-record" onclick="toggleRecording()" class="w-14 h-14 rounded-full bg-red-100 text-red-600 border-2 border-red-200 flex items-center justify-center hover:bg-red-200 transition shadow-sm">
                        <i id="record-icon" class="fas fa-microphone text-xl"></i>
                    </button>
                    <div class="text-sm">
                        <div id="recording-status" class="font-bold text-slate-700">Start Recording</div>
                        <div class="text-xs text-slate-400">Record to check your pronunciation</div>
                    </div>
                </div>
                <!-- Player appears here -->
                <div id="audio-player-container" class="hidden flex items-center gap-2">
                    <audio id="audio-playback" controls class="h-10 w-48 md:w-64"></audio>
                </div>
            </div>

            <!-- Big Reveal Button -->
            <button id="btn-reveal-next" onclick="revealNext()" class="w-full py-4 rounded-xl bg-slate-800 hover:bg-slate-700 text-white font-bold text-xl shadow-lg flex items-center justify-center gap-3 transition-all transform active:scale-[0.98] border-b-4 border-slate-900 active:border-b-0 active:translate-y-1">
                <span>Next Answer</span>
                <i class="fas fa-chevron-right"></i>
            </button>
            <div class="text-center text-xs text-slate-400 font-english">Read aloud, then tap to check answer.</div>
        </div>
    </div>

    <script>
        // DATA SOURCE: Seijin no Hi (Part 3)
        const chunks = [
            { id: 1,  pre: "", blank: "On", post: " this day in Japan,", jp: "この日に日本では，", hint: "( )" },
            { id: 2,  pre: "young adults dress up ", blank: "in", post: " traditional clothes", jp: "若者が伝統的な衣装で着飾り，", hint: "( )" },
            { id: 3,  pre: "and ", blank: "attend", post: " a ceremony at local city offices.", jp: "地元の役所で式典に出席する。", hint: "(a...)" },
            { id: 4,  pre: "They ", blank: "receive", post: " gifts and have a party.", jp: "彼らは贈り物をもらいそしてパーティーを開く。", hint: "(r...)" },
            { id: 5,  pre: "", blank: "Like", post: " the Quinceanera,", jp: "キンセアニェーラのように，", hint: "( )" },
            { id: 6,  pre: "", blank: "clothes", post: " are important here, too.", jp: "服装がここでも重要である。", hint: "(c...)" },
            { id: 7,  pre: "Women wear a kimono with very long ", blank: "sleeves", post: " (99–107cm),", jp: "女性たちは非常に長い袖（99〜107cm）の着物を着るのだが，", hint: "(s...)" },
            { id: 8,  pre: "a style ", blank: "which", post: " is only ", blank2: "worn", post2: " by single women.", jp: "それは独身女性たちによってのみ着られるスタイルである。", hint: "( )", hint2: "(w...)" },
            { id: 9,  pre: "Dark kimonos or suits are usually ", blank: "worn", post: " by men.", jp: "濃い色の着物やスーツは通常男性たちによって着られる。", hint: "(w...)" },
            { id: 10,  pre: "The ", blank: "legal", post: " age of adulthood was ", blank2: "lowered", post2: "", jp: "２ 法定成人年齢は引き下げられた", hint: "(l...)", hint2: "(l...)" },
            { id: 11, pre: "from 20 to 18 ", blank: "in", post: " April 2022.", jp: "2022年4月に。(20歳から18歳に)", hint: "( )" },
            { id: 12, pre: "", blank: "As a result", post: ",", jp: "その結果，", hint: "( )( )( )" },
            { id: 13, pre: "18-year-olds can ", blank: "get married", post: ",", jp: "18歳は結婚したり，", hint: "( )(m...)" },
            { id: 14, pre: "sign ", blank: "contracts", post: ",", jp: "契約したり，", hint: "(c...s)" },
            { id: 15, pre: "and ", blank: "take out", post: " loans", jp: "そしてローンを組んだりできる", hint: "(t...)( )" },
            { id: 16, pre: "without the ", blank: "consent", post: " of their parents.", jp: "彼らの親の同意なしに。", hint: "(con...)" },
            { id: 17, pre: "But teenagers are still ", blank: "banned", post: "", jp: "しかし10代の若者はまだ禁止されている", hint: "(b...)" },
            { id: 18, pre: "", blank: "from", post: " smoking, drinking alcohol, and gambling", jp: "喫煙，飲酒，ギャンブルをすることを", hint: "(f...)" },
            { id: 19, pre: "", blank: "until", post: " they are 20.", jp: "彼らが20歳になるまで。", hint: "( )" },
            { id: 20, pre: "It is the first change to the law ", blank: "that", post: " ", blank2: "defines", post2: " adulthood", jp: "成人を定義する法律への初めての変更である", hint: "( )", hint2: "(de...)" },
            { id: 21, pre: "", blank: "since", post: " it was first set in 1876.", jp: "それ(その法律)が1876年に最初に制定されて以来。", hint: "( )" }
        ];

        // --- App State ---
        let state = {
            jpVisible: true,
            blanks: [], // Stores {id, word, element, isRevealed} for all blanks in order
            currentBlankIndex: 0,
            mediaRecorder: null,
            audioChunks: [],
            isRecording: false
        };

        const app = document.getElementById('app');
        const progressText = document.getElementById('progress-text');
        
        // --- Initialization ---
        function init() {
            app.innerHTML = '';
            state.blanks = [];
            
            chunks.forEach((chunk, index) => {
                const row = document.createElement('div');
                const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50';
                row.className = `row-container flex flex-col md:flex-row md:items-stretch ${bgClass} border-l-8 border-l-transparent`;
                row.id = `row-${chunk.id}`;

                let sentenceHtml = `<span class="text-slate-800">${chunk.pre}</span>`;
                
                // Blank 1
                if(chunk.blank !== null) {
                    sentenceHtml += createBlankHtml(chunk.id, chunk.blank, chunk.hint);
                }

                sentenceHtml += `<span class="text-slate-800">${chunk.post}</span>`;
                
                // Blank 2
                if(chunk.blank2) {
                    sentenceHtml += " ";
                    sentenceHtml += createBlankHtml(chunk.id, chunk.blank2, chunk.hint2);
                }
                
                if(chunk.post2) {
                    sentenceHtml += `<span class="text-slate-800">${chunk.post2}</span>`;
                }

                row.innerHTML = `
                    <div class="flex-[3] p-6 md:border-r md:border-slate-200 flex items-center justify-between gap-4">
                        <div class="text-2xl font-english leading-relaxed tracking-wide text-slate-900 w-full flex flex-wrap items-center">
                            ${sentenceHtml}
                        </div>
                        <button onclick="playChunkAudio(${chunk.id})" class="shrink-0 w-12 h-12 rounded-full bg-slate-100 text-slate-500 hover:bg-blue-100 hover:text-blue-600 flex items-center justify-center transition border border-slate-200" title="Play line audio">
                            <i class="fas fa-volume-up text-xl"></i>
                        </button>
                    </div>
                    <div class="flex-[2] p-6 flex items-center">
                        <p class="jp-text text-slate-700 text-lg font-medium leading-relaxed font-japanese transition-opacity duration-300 ${state.jpVisible ? 'opacity-100' : 'opacity-0 select-none'}">${chunk.jp}</p>
                    </div>
                `;
                app.appendChild(row);
            });

            // Bind elements to state
            const blankEls = document.querySelectorAll('.blank-container');
            blankEls.forEach((el, idx) => {
                // Setup click to reveal
                el.onclick = () => revealSpecific(idx);
                // Store ref
                state.blanks[idx].element = el;
            });

            updateProgress();
        }

        // Logic to generate HTML for blanks and register them in state
        function createBlankHtml(chunkId, word, hint) {
            // Split multiple blanks if needed (e.g., "( )( )( )")
            const hintParts = hint ? hint.match(/\([^\)]*\)/g) : null;
            const wordParts = word ? word.trim().split(/\s+/) : [];
            const isTargetSentence = word.split(' ').length > 5 && (!hintParts || hintParts.length <= 1);
            
            let html = "";
            
            if (!isTargetSentence && hintParts && hintParts.length > 1 && wordParts.length === hintParts.length) {
                // Multi-blank logic
                for (let i = 0; i < hintParts.length; i++) {
                    const h = hintParts[i];
                    const w = wordParts[i];
                    html += generateSingleBlank(chunkId, w, h);
                }
            } else {
                // Single blank logic
                html += generateSingleBlank(chunkId, word, hint, isTargetSentence);
            }
            return html;
        }

        function generateSingleBlank(chunkId, word, hint, isTarget = false) {
            // Register to state
            state.blanks.push({
                chunkId: chunkId,
                word: word,
                isRevealed: false,
                element: null // will be set after render
            });

            // Clean hint for display
            let displayHint = hint;
            if(hint.startsWith('(') && hint.endsWith(')')) {
                displayHint = hint.slice(1, -1);
            }

            let classes = "blank-container text-2xl font-english";
            if (isTarget) classes += " target-sentence";

            return `<span class="${classes}">
                        <span class="paren">(</span>
                        <span class="hint-text">${displayHint}</span>
                        <span class="paren paren-right">)</span>
                    </span>`;
        }


        // --- ACTION FUNCTIONS ---

        function revealNext() {
            if (state.currentBlankIndex >= state.blanks.length) return; // All done
            
            const target = state.blanks[state.currentBlankIndex];
            revealBlank(target);
            state.currentBlankIndex++;
            
            // Auto scroll or highlight row
            highlightRow(target.chunkId);
            
            updateProgress();
        }

        function revealSpecific(index) {
            // Allow clicking ahead, but update current index to follow
            if (state.blanks[index].isRevealed) return;
            
            const target = state.blanks[index];
            revealBlank(target);
            
            // If user clicked ahead, allow it. Update current pointer if we clicked the one we were waiting for.
            if (index === state.currentBlankIndex) {
                state.currentBlankIndex++;
            }
            highlightRow(target.chunkId);
            updateProgress();
        }

        function revealBlank(blankObj) {
            const el = blankObj.element;
            if(!el) return;
            
            blankObj.isRevealed = true;
            
            // Change style to revealed
            el.innerHTML = blankObj.word;
            el.className = "blank-container revealed text-2xl font-english fade-in";
        }

        function highlightRow(chunkId) {
            // Remove active from all
            document.querySelectorAll('.row-container').forEach(r => {
                r.classList.remove('active-row');
                r.classList.remove('playing');
            });
            
            const row = document.getElementById(`row-${chunkId}`);
            if(row) {
                row.classList.add('active-row');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function updateProgress() {
            const revealedCount = state.blanks.filter(b => b.isRevealed).length;
            progressText.innerText = `${revealedCount}/${state.blanks.length}`;
            
            const btn = document.getElementById('btn-reveal-next');
            if(revealedCount >= state.blanks.length) {
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.classList.remove('bg-slate-800', 'hover:bg-slate-700');
                btn.innerHTML = '<i class="fas fa-check"></i> Complete!';
            }
        }

        function resetApp() {
            state.currentBlankIndex = 0;
            init();
            
            // Reset recorder UI if needed
            const btn = document.getElementById('btn-record');
            const icon = document.getElementById('record-icon');
            const status = document.getElementById('recording-status');
            const playerContainer = document.getElementById('audio-player-container');
            
            if(state.isRecording && state.mediaRecorder) {
                state.mediaRecorder.stop();
                state.isRecording = false;
            }
            
            btn.classList.add('bg-red-100', 'text-red-600');
            btn.classList.remove('bg-red-600', 'text-white', 'pulse-recording');
            icon.className = "fas fa-microphone text-xl";
            status.innerText = "Start Recording";
            status.className = "font-bold text-slate-700";
            playerContainer.classList.add('hidden');
        }

        // --- AUDIO RECORDER ---
        
        async function toggleRecording() {
            const btn = document.getElementById('btn-record');
            const icon = document.getElementById('record-icon');
            const status = document.getElementById('recording-status');
            const playerContainer = document.getElementById('audio-player-container');
            const audioEl = document.getElementById('audio-playback');

            if (!state.isRecording) {
                // Start Recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    state.mediaRecorder = new MediaRecorder(stream);
                    state.audioChunks = [];

                    state.mediaRecorder.ondataavailable = event => {
                        state.audioChunks.push(event.data);
                    };

                    state.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioEl.src = audioUrl;
                        playerContainer.classList.remove('hidden');
                    };

                    state.mediaRecorder.start();
                    state.isRecording = true;
                    
                    // UI Updates
                    btn.classList.remove('bg-red-100', 'text-red-600');
                    btn.classList.add('bg-red-600', 'text-white', 'pulse-recording');
                    icon.className = "fas fa-stop text-xl";
                    status.innerText = "Recording...";
                    status.className = "font-bold text-red-600 animate-pulse";
                    playerContainer.classList.add('hidden'); // Hide player while recording

                } catch (err) {
                    console.error("Mic Error:", err);
                    alert("マイクへのアクセスが許可されていません。設定を確認してください。");
                }
            } else {
                // Stop Recording
                if (state.mediaRecorder) {
                    state.mediaRecorder.stop();
                }
                state.isRecording = false;
                
                // UI Updates
                btn.classList.add('bg-red-100', 'text-red-600');
                btn.classList.remove('bg-red-600', 'text-white', 'pulse-recording');
                icon.className = "fas fa-microphone text-xl";
                status.innerText = "Start Recording";
                status.className = "font-bold text-slate-700";
            }
        }

        // --- MODEL AUDIO ---
        function playChunkAudio(id) {
            const chunk = chunks.find(c => c.id === id);
            if(!chunk) return;
            
            // Build full text
            let text = chunk.pre + " " + chunk.blank + " " + chunk.post;
            if(chunk.blank2) text += " " + chunk.blank2 + " " + chunk.post2;
            
            speak(text);
        }

        function playAllAudio() {
            // Simple concatenation of all text
            let fullText = chunks.map(c => {
                let text = c.pre + " " + c.blank + " " + c.post;
                if(c.blank2) text += " " + c.blank2 + " " + c.post2;
                return text;
            }).join(". ");
            
            speak(fullText);
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'en-US';
            ut.rate = 0.9;
            window.speechSynthesis.speak(ut);
        }

        // --- UI TOGGLES ---
        document.getElementById('btn-toggle-jp').addEventListener('click', () => { 
            state.jpVisible = !state.jpVisible; 
            const s = document.getElementById('btn-toggle-jp').querySelector('b');
            const els = document.querySelectorAll('.jp-text');
            
            if(state.jpVisible) {
                s.innerText = "ON"; s.className = "text-blue-600";
                els.forEach(e => { e.classList.remove('opacity-0', 'select-none'); e.classList.add('opacity-100'); });
            } else {
                s.innerText = "OFF"; s.className = "text-gray-400";
                els.forEach(e => { e.classList.remove('opacity-100'); e.classList.add('opacity-0', 'select-none'); });
            }
        });
        
        // Initial Run
        init();

    </script>
</body>
</html>